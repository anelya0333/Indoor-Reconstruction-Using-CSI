#!/usr/bin/env bash
###############################################################################
# 01_extract_frames.sh
#
# Description:
#   Extracts image frames from a recorded video (e.g., camera capture synchronized
#   with CSI data) using FFmpeg. Supports two modes:
#     1. Extract all frames ("all" mode)
#     2. Sample frames at a given rate (e.g., 1 FPS)
#
#   The output frames are stored as JPEGs in `dataset_out/frames/`, and each frame
#   filename is numbered sequentially. If a corresponding CSV file with original
#   video timestamps (`video_frame_pts.csv`) exists, it will be noted for reference.
#
# -----------------------------------------------------------------------------
# Usage:
#   ./01_extract_frames.sh <video_path> <mode>
#
#   Examples:
#     ./01_extract_frames.sh csi_capture/room_video.mp4 1
#         → Extract frames at 1 frame per second (1 FPS)
#
#     ./01_extract_frames.sh csi_capture/room_video.mp4 all
#         → Extract all frames without skipping any
#
# -----------------------------------------------------------------------------
# Arguments:
#   video_path : Path to the video file (e.g., .mp4)
#   mode       : Either:
#                  "all" → extract every frame, or
#                  <number> → extract <number> frames per second (FPS)
#
# Outputs:
#   - Frame images saved to: dataset_out/frames/frame_XXXXXXXXXX.jpg
#   - Logs printed to stdout for progress and file checks
#
# Requirements:
#   - ffmpeg must be installed and accessible in $PATH
#
###############################################################################

# --- Safety configuration ----------------------------------------------------
set -euo pipefail
# -e : exit on any error
# -u : treat unset variables as an error
# -o pipefail : fail a pipeline if any command fails

# --- Input arguments ---------------------------------------------------------
IN="${1:?path to video}"   # First argument: input video file path (required)
MODE="${2:-1}"              # Second argument: "all" or numeric FPS (default=1)

# --- Output directories and references ---------------------------------------
OUT_DIR="dataset_out/frames"                      # Directory for extracted frames
PTS_CSV="csi_capture/video_frame_pts.csv"         # Optional CSV of frame timestamps
mkdir -p "$OUT_DIR"                               # Ensure output directory exists

# --- Extraction logic ---------------------------------------------------------
if [[ "$MODE" == "all" ]]; then
  ###########################################################################
  # MODE: "all"
  # Extract every frame from the input video. Each frame is written as a JPEG.
  #
  # Options explained:
  #   -hide_banner   : suppress ffmpeg startup info
  #   -y             : overwrite output files without asking
  #   -i "$IN"       : input video file
  #   -vsync 0       : disable frame duplication/dropping
  #   -frame_pts 1   : include presentation timestamps (used for frame numbering)
  #
  # Output naming pattern:
  #   frame_0000000001.jpg, frame_0000000002.jpg, ...
  ###########################################################################
  ffmpeg -hide_banner -y -i "$IN" -vsync 0 -frame_pts 1 \
         "$OUT_DIR/frame_%010d.jpg"

else
  ###########################################################################
  # MODE: numeric FPS (e.g., "1", "2", "5")
  # Extract frames at a fixed rate specified by $MODE (frames per second).
  #
  # Options explained:
  #   -vf "fps=${FPS}" : sampling filter to select frames at the desired FPS
  #   -vsync vfr       : variable frame rate output (prevents duplicates)
  #
  # Output naming pattern:
  #   frame_000001.jpg, frame_000002.jpg, ...
  ###########################################################################
  FPS="$MODE"
  ffmpeg -hide_banner -y -i "$IN" -vf "fps=${FPS}" -vsync vfr \
         "$OUT_DIR/frame_%06d.jpg"
fi

# --- Completion summary -------------------------------------------------------
echo "Frames successfully extracted to: $OUT_DIR"

# Check for existence of the reference PTS CSV file
if [[ -f "$PTS_CSV" ]]; then
  echo "Found PTS reference file: $PTS_CSV"
else
  echo "WARNING: Expected PTS CSV not found at: $PTS_CSV"
  echo "         (This file is typically generated by your capture script.)"
fi
